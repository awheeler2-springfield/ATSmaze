<script>
/* ==============================
   STATE
==============================*/

let nodes = [];
let edges = new Map();
let current = null;
let moves = 0;
let trapHits = 0;
let stageOrder = ["summary","skills","experience","projects","certifications","education"];
let stageIndex = 0;

/* ==============================
   NODE + EDGE ENGINE
==============================*/

function addNode(el,x,y,section,trap=false,type="format"){
  const id = nodes.length;
  el.dataset.id = id;
  nodes.push({id,x,y,section,trap,type});
  el.addEventListener("click",()=>handleClick(id));
}

function connect(a,b){
  if(!edges.has(a)) edges.set(a,new Set());
  if(!edges.has(b)) edges.set(b,new Set());
  edges.get(a).add(b);
  edges.get(b).add(a);
}

function handleClick(id){
  if(current===null){
    activate(id);
    return;
  }
  if(edges.get(current)?.has(id)){
    moveTo(id);
  }
}

/* ==============================
   MOVE LOGIC
==============================*/

function moveTo(id){
  moves++;
  activate(id);

  const node = nodes[id];

  if(node.trap){
    document.querySelector(`[data-id="${id}"]`).classList.add("bad");
    trapHits++;
  }

  if(node.section===stageOrder[stageIndex]){
    stageIndex++;
  }

  updateStats();
  checkComplete();
  highlightNeighbors();
}

function activate(id){
  document.querySelectorAll(".active").forEach(e=>e.classList.remove("active"));
  const el=document.querySelector(`[data-id="${id}"]`);
  el.classList.add("active","visited");
  current=id;
}

function highlightNeighbors(){
  document.querySelectorAll(".neighbor").forEach(e=>e.classList.remove("neighbor"));
  if(current===null) return;
  edges.get(current)?.forEach(n=>{
    document.querySelector(`[data-id="${n}"]`).classList.add("neighbor");
  });
}

/* ==============================
   SCORING
==============================*/

function updateStats(){
  let structuralPenalty = Math.floor(moves/6);
  let trapPenalty = trapHits * 12;
  let score = Math.max(0, 100 - structuralPenalty - trapPenalty);

  document.getElementById("stats").textContent =
    `Moves: ${moves} | Trap Hits: ${trapHits} | Section: ${stageIndex}/${stageOrder.length} | Score: ${score}`;
}

function checkComplete(){
  if(nodes[current].section==="education"){
    document.getElementById("report").innerHTML =
      `<h3>ATS Analysis</h3>
       <p>Total Moves: ${moves}</p>
       <p>Trap Hits: ${trapHits}</p>
       <p>Interpretation:</p>
       <ul>
         <li>High moves = structural inefficiency</li>
         <li>Trap hits = formatting interference</li>
         <li>Section order compliance improves ATS clarity</li>
       </ul>`;
  }
}

/* ==============================
   BUILD
==============================*/

function build(){
  nodes=[];
  edges.clear();
  moves=0;
  trapHits=0;
  stageIndex=0;
  current=null;
  document.getElementById("report").innerHTML="";

  buildHeader();
  buildSummary();
  buildSkills();
  buildExperience();
  buildEducation();

  updateStats();
}

function buildHeader(){
  const header=document.getElementById("header");
  header.innerHTML="";
  let a=span("FIRST"); header.appendChild(a); addNode(a,0,0,"header");
  let b=span("LAST"); header.appendChild(b); addNode(b,1,0,"header");
  connect(0,1);
}

function buildSummary(){
  const el=document.getElementById("summary");
  el.innerHTML="";
  let a=span("Data-driven"); el.appendChild(a); addNode(a,0,1,"summary");
  let b=span("analytics"); el.appendChild(b); addNode(b,1,1,"summary");
  let c=span("professional"); el.appendChild(c); addNode(c,2,1,"summary");
  connect(nodes.length-3,nodes.length-2);
  connect(nodes.length-2,nodes.length-1);
}

function buildSkills(){
  const el=document.getElementById("skills");
  el.innerHTML="";
  let a=span("GA4"); el.appendChild(a); addNode(a,0,2,"skills");
  let b=span("SEO"); el.appendChild(b); addNode(b,1,2,"skills");
  let c=span("Skill-Bars"); el.appendChild(c); addNode(c,2,2,"skills",true,"format");
  connect(nodes.length-3,nodes.length-2);
  connect(nodes.length-2,nodes.length-1);
}

function buildExperience(){
  const exp=document.getElementById("experience");
  exp.innerHTML="";
  let idStart=nodes.length;

  let gridSize=6; // reduced for performance
  for(let y=0;y<gridSize;y++){
    for(let x=0;x<gridSize;x++){
      let word = Math.random()<0.2 ? "TABLE" : "optimized";
      let trap = word==="TABLE";
      let sp=span(word);
      exp.appendChild(sp);
      addNode(sp,x,y+4,"experience",trap,"format");

      let id = idStart + y*gridSize + x;
      if(x>0) connect(id-1,id);
      if(y>0) connect(id-gridSize,id);
    }
    exp.appendChild(document.createElement("br"));
  }
}

function buildEducation(){
  const edu=document.getElementById("education");
  edu.innerHTML="";
  let e1=span("B.A."); edu.appendChild(e1); addNode(e1,0,20,"education");
}

function span(text){
  let s=document.createElement("span");
  s.className="node";
  s.textContent=text+" ";
  return s;
}

function reset(){ build(); }

build();
</script>
